<!DOCTYPE html>
<html>
<head>
    <title>AI Agent API Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        #output { border: 1px solid #333; padding: 10px; margin: 10px 0; height: 400px; overflow-y: scroll; background: #2a2a2a; }
        .event { margin: 5px 0; padding: 5px; border-left: 3px solid #4CAF50; }
    </style>
</head>
<body>
    <h1>AI Agent API Connection Test</h1>
    
    <div>
        <input type="text" id="queryInput" placeholder="Enter your query..." style="width: 400px; padding: 8px;">
        <button onclick="testQuery()">Test Query</button>
        <button onclick="clearOutput()">Clear</button>
    </div>
    
    <div id="output"></div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentEventSource = null;

        function log(message) {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = 'event';
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        async function testQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('Please enter a query');
                return;
            }

            try {
                log(`Testing connection to ${API_URL}`);
                
                // Test health endpoint first
                const healthResponse = await fetch(`${API_URL}/health`);
                const healthData = await healthResponse.json();
                log(`‚úÖ Health check: ${JSON.stringify(healthData)}`);

                // Create query
                log(`üîÑ Creating query: "${query}"`);
                const queryResponse = await fetch(`${API_URL}/v1/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });
                
                const queryData = await queryResponse.json();
                log(`‚úÖ Query created: ${JSON.stringify(queryData)}`);
                
                // Start SSE stream
                if (currentEventSource) {
                    currentEventSource.close();
                }
                
                const runId = queryData.run_id;
                log(`üîÑ Starting SSE stream for run_id: ${runId}`);
                
                currentEventSource = new EventSource(`${API_URL}/v1/stream/${runId}`);
                
                currentEventSource.onopen = function(event) {
                    log('‚úÖ SSE connection opened');
                };
                
                currentEventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì° SSE Event: ${JSON.stringify(data)}`);
                    } catch (e) {
                        log(`‚ùå Failed to parse SSE data: ${event.data}`);
                    }
                };
                
                currentEventSource.onerror = function(event) {
                    log(`‚ùå SSE Error: ${JSON.stringify(event)}`);
                    if (currentEventSource.readyState === EventSource.CLOSED) {
                        log('üî¥ SSE connection closed');
                    }
                };
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        // Initial connection test
        window.onload = function() {
            log('üöÄ Starting API test page');
            document.getElementById('queryInput').value = 'What is the capital of France?';
        };
    </script>
</body>
</html>
